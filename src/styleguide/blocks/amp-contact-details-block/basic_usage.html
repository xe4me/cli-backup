<form [formGroup]="form" class='nl-form p+'>
    <div [amp-block-loader]="childBlocks" [fdn]="fullyDistinguishedName" [form]="form"></div>
</form>

<section class="section">
    <article class="section">
        <h2 class="mb- ml mt+">
            Above is an example of a "Contact Details" block.
        </h2>
        <p class="ml small">
            This block is loaded from a <strong>form-def.def.json</strong> file by the 'amp-block-loader' directive.
            <br>It should be <strong>the default way of loading a block.</strong>.
        </p>
    </article>

    <article class="section">
        <h2 class="mb- ml mt+">Example</h2>
        <p class="para ml">
            In a "form-def.def.json" file, in any array of blocks:
        </p>
        <pre>
            <code syntaxHighlight class="json">
    &#123;
        "name": "contactDetails",
        "blockType": "AmpContactDetailsBlockComponent",
        "blockLayout": "INLINE",
        "commonBlock": true,
        "path": "modules/amp-contact-details-block/components/amp-contact-details-block/amp-contact-details-block.component"
    &#125;
            </code>
        </pre>
    </article>

    <article class="section">
        <h2 class="mb- ml mt+">Default props</h2>
        <pre>
            <code syntaxHighlight class="json">
    &#123;
        "blockTitle": "And your contact details...",
        "controls": [
            &#123;
                "id": "emailAddress",
                "label": "Email",
                "required": true,
                "tooltipMessage": "Confirmation of your application will be sent to this email address.",
                "prepopMapping": "payload.contactDetails.emailAddress"
            &#125;,
            &#123;
                "id": "mobileNumber",
                "label": "Mobile number",
                "required": true,
                "tooltipMessage": "A mobile phone number is required to allow AMP Bank to securely protect your account.",
                "errors": &#123;
                    "required": "Mobile number is a required field.",
                    "pattern": "Mobile number must be in the format 04nnnnnnnn"
                &#125;,
                "prepopMapping": "payload.contactDetails.mobilePhone",
                "prepopMappingParser": "parseMobile"
            &#125;,
            &#123;
                "id": "homeNumber",
                "label": "Home number",
                "required": false,
                "prepopMapping": "payload.contactDetails.homePhone"
            &#125;
        ]
    &#125;
            </code>
        </pre>
    </article>

    <article class="section">
        <h2 class="mb- ml mt+">"custom" section</h2>
        <ul class="bml">
            <li>
                You can override any prop by adding a <strong>"custom.overrides"</strong> object to your block definition. Some examples:
            </li>
        </ul>
        <pre>
            <code syntaxHighlight class="json">
    &#123;
        "custom": &#123;
            "overrides": &#123;
                "blockTitle": "My contact details",
                "controls[0].label": "My email label",
                "controls[1].errors.required": "Mobile number is a highly required field.",
                "controls[3].required": true
            &#125;
        &#125;
    &#125;
            </code>
        </pre>
        <ul class="bml">
            <li>
                Or you can override everything by providing all of your custom props:
            </li>
        </ul>
        <pre>
            <code syntaxHighlight class="json">
    &#123;
        "blockTitle": "My block title",
        "controls": [
            &#123;
                "id": "myEmailAddress",
                "label": "My email",
                "required": true,
                "tooltipMessage": "My tooltip..."
            &#125;,
            &#123;
                "id": "myMobileNumber",
                "label": "My mobile number",
                "required": true,
                "tooltipMessage": "My tooltip...",
                "errors": &#123;
                    "required": "My required error",
                    "pattern": "My pattern error"
                &#125;
            &#125;,
            &#123;
                "id": "myHomeNumber",
                "label": "My home number",
                "required": false
            &#125;
        ]
    &#125;
            </code>
        </pre>
    </article>

    <article class="section">
        <h2 class="mb- ml mt+">"Prepopulation" capability</h2>
        <ul class="bml">
            <li>
                This block is prepop enabled, which means that by default (whether it's on initialization of the block or by an explicit amp-login-block) it will check for a valid session. If so, it will call api-customer and map the email, mobile, homePhone into the corresponding controls. This behaviour is control via "prepopMapping" in each of the custom controls element.
            </li>
        </ul>
        <pre>
            <code syntaxHighlight class="json">
    &#123;
        "custom": &#123;
            "overrides": &#123;
                "controls[0].prepopMapping": "payload.contactDetails.emailAddress"
            &#125;
        &#125;
    &#125;
            </code>
        </pre>
        <ul class="bml">
            <li>
                Or removing this attribute will disable prepop:
            </li>
        </ul>
        <pre>
            <code syntaxHighlight class="json">
    &#123;
        "custom": &#123;
            "overrides": &#123;
                "controls[0].prepopMapping": null
            &#125;
        &#125;
    &#125;
            </code>
        </pre>
        <ul class="bml">
            <li>
                Furthermore, some prepop data requires a level of massaging (such as date format or stripping whitespace etc..), you can achieve this via "prepopMappingParser" that maps to a function in your injected PrepopulationService subclass:
            </li>
        </ul>
        <pre>
            <code syntaxHighlight class="json">
    &#123;
        "custom": &#123;
            "overrides": &#123;
                "controls[1].prepopMapping": "payload.contactDetails.mobilePhone",
                "controls[1].prepopMappingParser": "parseMobile"
            &#125;
        &#125;
    &#125;
            </code>
        </pre>

        <pre>
            <code syntaxHighlight class="json">
    import &#123; Injectable &#125; from '@angular/core';
    import &#123; PrepopulationService &#125; from '../../../services/prepopulation/prepopulation.service';
    import &#123; CustomerDetailsService &#125; from '../../../services/customer-details/customer-details.service';
    import &#123; LoginStatusService &#125; from '../../../services/login/login-status.service';

    @Injectable()
    export class PrepopAmpContactDetailsService extends PrepopulationService &#123;

        constructor ( public customerDetailsService : CustomerDetailsService,
                    public loginStatusService : LoginStatusService ) &#123;
            super(customerDetailsService, loginStatusService);
        &#125;

        /**
        * Rules so far is remove white spaces and replace +61 with 0 according to JIRA
        * https://teamtools.amp.com.au/jira/browse/BET-3979
        *
        * But if we get too smart, do take a look at Google i18n
        * https://github.com/googlei18n/libphonenumber/tree/master/javascript/i18n/phonenumbers
        */
        private parseMobile (mobile : string ) &#123;
            const validMobileRegex = /^04\d&#123;8&#125;$/;
            if (mobile) &#123;
                let parseMobile = mobile.replace(/ /g, '');
                if (parseMobile) &#123;
                    parseMobile = parseMobile.replace(/^\+61/, '0');
                &#125;

                if (validMobileRegex.test(parseMobile)) &#123;
                    return parseMobile;
                &#125;
            &#125;
            return null;
        &#125;
    &#125;
            </code>
        </pre>

    </article>
</section>
